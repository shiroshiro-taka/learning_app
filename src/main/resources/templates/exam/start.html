<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title th:text="${exam?.examName} + ' - è©¦é¨“é–‹å§‹'">æ¨¡æ“¬è©¦é¨“</title>
<!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    // Tailwindã®ã‚«ã‚¹ã‚¿ãƒ è¨­å®š
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'primary-blue': '#1c55c8', // ãƒœã‚¿ãƒ³ã‚„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆç”¨ã®é’
                    'primary-blue-hover': '#1747a5',
                    'success-green': '#10b981', // è§£ç­”æ¸ˆã¿ã®ç·‘
                    'error-red': '#ef4444',     // çµ‚äº†ãƒœã‚¿ãƒ³ã®èµ¤
                    'accent-yellow': '#facc15', // ç¾åœ¨ã®å•é¡Œã®é»„è‰²
                    'dark-panel': '#2d3748',    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®èƒŒæ™¯ (gray-800ç›¸å½“)
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
            }
        }
    }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<style>
  /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  body { 
    display: flex;
    flex-direction: column; 
    height: 100vh; 
  }
  
  /* DBã®æ”¹è¡Œãƒ»ç©ºç™½ã‚’ä¿æŒã™ã‚‹CSS */
  .preserve-format {
    white-space: pre-wrap;
  }

  /* highlight.jsãŒé©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å…¨ä½“ */
  .hljs {
      padding: 0.75em;
      background: #f3f3f3;
      border-radius: 0.5rem;
      line-height: 1.4;
      overflow-x: auto;
  }

  /* é¸æŠè‚¢ãŒé¸æŠã•ã‚ŒãŸã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ« (selected) */
  .selected { 
      background-color: #eff6ff; /* blue-50 */
      border: 1px solid #93c5fd; /* blue-300 */
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  /* è§£ç­”çŠ¶æ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .q-status-btn { 
    position: relative;
    transition: background-color 0.1s;
  }
  .status-answered { background-color: #10b981 !important; } /* success-green */
  .status-current { background-color: #facc15 !important; border: 2px solid #2d3748 !important; color: #2d3748 !important; } /* accent-yellow */
  .status-review::before { 
    content: "ğŸ“Œ"; 
    position: absolute; top: -8px; right: -8px; 
    font-size: 1rem; color: #1c55c8; /* primary-blue */
    line-height: 1;
    text-shadow: 0 0 2px rgba(0,0,0,0.5);
  }

  /* è©¦é¨“çµ‚äº†ãƒœã‚¿ãƒ³ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
  #finishForm { margin: 0; }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒ¼ (å›ºå®š) -->
<div class="header-bar sticky top-0 z-10 flex flex-col md:flex-row justify-between items-center px-4 md:px-8 py-3 border-b-4 border-gray-300 bg-white shadow-md">
    <h1 class="exam-title text-xl md:text-2xl font-bold text-gray-800 mb-2 md:mb-0" th:text="'æ¨¡æ“¬è©¦é¨“ï¼š' + ${exam.examName}">æ¨¡æ“¬è©¦é¨“åï¼šæ¨¡æ“¬è©¦é¨“å</h1>
    
    <div id="timer-display" class="flex items-center space-x-2 text-xl md:text-2xl font-extrabold text-error-red">
        <!-- âŒ› ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ  -->
        <span>âŒ›</span>
        <span class="timer-text">æ®‹ã‚Šæ™‚é–“: <span id="timer">--:--</span></span>
    </div>
</div>

<!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½) -->
<div class="question-main flex-grow overflow-y-auto p-4 md:p-8 max-w-5xl mx-auto w-full">
    <div id="question-container">
        <div th:each="q, iterStat : ${examQuestions}" 
             class="question bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6" 
             th:id="'q-'+${q.question.id}" 
             th:data-index="${iterStat.index}"
             th:data-question-id="${q.question.id}">
            
            <div class="question-header flex items-start mb-4 pb-3 border-b border-gray-200">
                <span class="question-number text-2xl font-extrabold text-primary-blue mr-4 flex-shrink-0" th:text="'å•' + ${iterStat.count}">å•1</span>
                <div class="question-text text-lg font-semibold text-gray-800 preserve-format" th:utext="${q.question.questionText}">å•é¡Œæ–‡ãƒ†ã‚­ã‚¹ãƒˆ</div>
            </div>

            <div class="choice-group space-y-3">
                <div th:each="c, cStat : ${q.question.choices}" 
                     class="choice cursor-pointer p-3 md:p-4 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-150 flex items-start"
                     th:data-choice-id="${c.id}">
                    <input type="radio" 
                           th:id="'q' + ${q.question.id} + 'c' + ${c.id}" 
                           th:name="'q' + ${q.question.id}" 
                           th:data-question-id="${q.question.id}"
                           th:value="${c.id}"
                           class="choice-radio mt-1 w-5 h-5 text-primary-blue focus:ring-primary-blue border-gray-300 flex-shrink-0">
                    <label th:for="'q' + ${q.question.id} + 'c' + ${c.id}" 
                           th:utext="${c.choiceText}"
                           class="ml-3 text-base text-gray-700 w-full cursor-pointer">é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆ</label>
                </div>
            </div>
            
            <div class="review-checkbox-container mt-6 pt-4 border-t border-dashed border-gray-300 text-sm flex items-center">
                 <input type="checkbox" th:id="'review-' + ${q.question.id}" class="review-check w-4 h-4 text-primary-blue rounded focus:ring-primary-blue border-gray-300">
                 <label th:for="'review-' + ${q.question.id}" class="ml-2 text-gray-600 font-medium cursor-pointer">å¾Œã§è¦‹ç›´ã™ãŸã‚ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹</label>
            </div>
            
        </div>
    </div>
</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼/ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« (å›ºå®š) -->
<div class="control-panel sticky bottom-0 z-10 bg-dark-panel p-4 shadow-2xl flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 w-full">
    
    <!-- è§£ç­”çŠ¶æ³ãƒ‘ãƒãƒ« -->
    <div id="answer-status-panel" class="flex flex-wrap justify-center sm:justify-start max-w-md">
        <!-- ãƒœã‚¿ãƒ³ã¯äºŒé‡ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•ã§ãã‚‹ã“ã¨ã‚’æ˜ç¤º -->
<!--        <p class="text-xs text-gray-400 w-full mb-1 text-center sm:text-left">è§£ç­”çŠ¶æ³ (ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•)</p>-->
        <div th:each="q, iterStat : ${examQuestions}" 
             class="q-status-btn w-8 h-8 m-1 bg-gray-600 text-white text-sm font-semibold rounded-md flex items-center justify-center cursor-pointer hover:bg-gray-500 transition duration-150" 
             th:data-index="${iterStat.index}"
             th:text="${iterStat.count}"
             th:title="'å•' + ${iterStat.count}"
             ondblclick="showQuestion([[${iterStat.index}]]);"> </div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="nav-buttons flex space-x-3">
        <button id="prev" type="button" class="px-5 py-2 rounded-lg font-bold text-white bg-primary-blue hover:bg-primary-blue-hover disabled:bg-gray-500 disabled:cursor-not-allowed transition duration-150 shadow-md">
            &larr; å‰ã®å•é¡Œã¸
        </button>
        <button id="next" type="button" class="px-5 py-2 rounded-lg font-bold text-white bg-primary-blue hover:bg-primary-blue-hover disabled:bg-gray-500 disabled:cursor-not-allowed transition duration-150 shadow-md">
            æ¬¡ã®å•é¡Œã¸ &rarr;
        </button>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <!-- space-x-3 ã‚’ space-x-5 ã«å¤‰æ›´ã—ã¦é–“éš”ã‚’åºƒã’ã¾ã—ãŸ -->
    <div class="control-actions flex space-x-5">
        <button id="review-list-btn" type="button" class="px-5 py-2 rounded-lg font-bold text-white bg-accent-yellow hover:bg-yellow-600 transition duration-150 shadow-md">
            è§£ç­”è¦‹ç›´ã—
        </button>
        <form th:action="@{/exam/finish}" method="post" id="finishForm">
            <input type="hidden" name="userExamId" id="userExamIdInput" th:value="${userExamId != null ? userExamId : 0}" />
            <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" id="finish-exam-btn" class="px-5 py-2 rounded-lg font-bold text-white bg-error-red hover:bg-red-600 transition duration-150 shadow-md">
                è©¦é¨“çµ‚äº†
            </button>
        </form>
    </div>
</div>


<script th:inline="javascript">
/*<![CDATA[*/
// **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**
let duration = /*[[${exam.durationMinutes}]]*/ 60; // æ¨¡æ“¬è©¦é¨“æ™‚é–“ï¼ˆåˆ†ï¼‰
let userExamId = /*[[${userExamId}]]*/ 0; // UserMockExamã®ID
let questionsCount = /*[[${examQuestions.size()}]]*/ 0; // å…¨å•é¡Œæ•°
let initialQuestionIndex = /*[[${initialQuestionIndex}]]*/ 0; // åˆæœŸè¡¨ç¤ºã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
let mockExamId = /*[[${exam.id}]]*/ 0; // MockExamã®IDã‚’å–å¾— (è¦‹ç›´ã—ç”»é¢é·ç§»ç”¨)

let existingAnswers = /*[[${existingAnswers}]]*/ []; 

// å•é¡ŒIDã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ãŸã‚ã®é…åˆ—
let questionsData = []; 
/*[# th:each="q, iterStat : ${examQuestions}"]*/
questionsData.push({ id: /*[[${q.question.id}]]*/ 0, index: /*[[${iterStat.index}]]*/ 0 });
/*[/]*/

// **çŠ¶æ…‹ç®¡ç†å¤‰æ•°**
let totalSeconds = duration * 60;
let currentQuestionIndex = 0; 
let timerInterval; 

// **è§£ç­”çŠ¶æ³ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (Ajaxã§ã®æ›´æ–°ã‚’åæ˜ ã•ã›ã‚‹)**
// key: questionId, value: { answered: true/false, review: true/false, choiceId: Long }
let answerStatus = {}; 

// **ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†**
function updateTimer() {
    let minutes = Math.floor(totalSeconds / 60);
    let seconds = totalSeconds % 60;
    let timeString = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#timer').text(timeString);
    
    if (totalSeconds <= 0) {
        clearInterval(timerInterval);
        console.warn('è©¦é¨“æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚è‡ªå‹•çš„ã«çµ‚äº†å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚');
        // è‡ªå‹•æå‡ºã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ãŒå¿…è¦ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ã®ãŒç†æƒ³çš„ã ãŒã€ä»Šå›ã¯å³æ™‚å®Ÿè¡Œ
        $('#finishForm').submit(); 
    } else {
        totalSeconds--;
    }
}

// **è§£ç­”çŠ¶æ³ãƒ‘ãƒãƒ«ã®æ›´æ–°**
function updateStatusPanel() {
    $('.q-status-btn').each(function(index) {
        let isCurrent = index === currentQuestionIndex;
        let questionId = questionsData[index].id;
        let status = answerStatus[questionId] || { answered: false, review: false };

        $(this).toggleClass('status-current', isCurrent);
        $(this).toggleClass('status-answered', status.answered);
        $(this).toggleClass('status-review', status.review);
    });
}

// **å•é¡Œè¡¨ç¤ºå‡¦ç†**
function showQuestion(index) {
    if (index < 0 || index >= questionsCount) {
        return;
    }

    $('.question').hide();
    let targetQuestion = $('#question-container .question').eq(index);
    targetQuestion.show();
    
    currentQuestionIndex = index;
    
    $('#prev').prop('disabled', currentQuestionIndex === 0);
    $('#next').prop('disabled', currentQuestionIndex === questionsCount - 1);
    
    updateStatusPanel();
    
    restoreAnswerState(questionsData[index].id);
}

// **è§£ç­”çŠ¶æ…‹ã®å¾©å…ƒ (ç”»é¢é·ç§»æ™‚)**
function restoreAnswerState(questionId) {
    let status = answerStatus[questionId] || {};
    
    $('#q-'+questionId).find('.choice').removeClass('selected');
    $('#q-'+questionId).find('.choice-radio').prop('checked', false);
    
    // status.choiceIdãŒå­˜åœ¨ã—ã€ã‹ã¤0ã‚ˆã‚Šå¤§ãã„ï¼ˆæœ‰åŠ¹ãªIDï¼‰ã®å ´åˆã«å¾©å…ƒ
    if (status.answered && status.choiceId != null && status.choiceId > 0) {
        let radio = $('#q'+questionId+'c'+status.choiceId);
        radio.prop('checked', true);
        radio.closest('.choice').addClass('selected');
    }
    
    // è¦‹ç›´ã—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¾©å…ƒ
    $('#review-' + questionId).prop('checked', status.review);
}


// **Ajaxã§å›ç­”é€ä¿¡ï¼ˆCSRFå¯¾å¿œï¼‰**
function sendAnswerAjax(questionId, choiceId, reviewFlag, isReviewToggle = false) {
    // ThymeleafãŒè‡ªå‹•æŒ¿å…¥ã™ã‚‹CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    let csrfToken = /*[[${_csrf.token}]]*/ '';
    let csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN'; 
    
    // choiceIdãŒnullã¾ãŸã¯0ã®å ´åˆã€æœªè§£ç­”ã¨ã—ã¦æ‰±ã†
    let finalChoiceId = choiceId; 
    
    $.ajax({
        url: '/exam/answer',
        type: 'POST',
        data: {
            userExamId: userExamId,
            questionId: questionId,
            choiceId: finalChoiceId, 
            reviewFlag: reviewFlag
        },
        beforeSend: function(xhr) {
            xhr.setRequestHeader(csrfHeader, csrfToken); 
        },
        success: function(){
            let status = answerStatus[questionId] || {};
            
            // finalChoiceIdãŒnullã¾ãŸã¯0ã®å ´åˆã€æœªè§£ç­”ã¨åˆ¤æ–­
            let isAnswered = (finalChoiceId != null && finalChoiceId > 0); 

            if (!isReviewToggle) {
                // é€šå¸¸ã®å›ç­”æ™‚
                status.answered = isAnswered; 
                status.choiceId = isAnswered ? finalChoiceId : null; 
            }
            // è¦‹ç›´ã—ãƒ•ãƒ©ã‚°ã¯å¸¸ã«æœ€æ–°ã‚’åæ˜ 
            status.review = reviewFlag; 
            
            answerStatus[questionId] = status;
            updateStatusPanel();
        },
        error: function(xhr){
            console.error('Ajax Error: å›ç­”ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', xhr.responseText);
        }
    });
}

// **é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯**
$(document).on('change', '.choice-radio', function() {
    let questionId = $(this).data('question-id');
    let choiceId = $(this).val(); 
    let reviewChecked = $('#review-' + questionId).is(':checked');
    
    // é¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ (UI)
    $('#q-'+questionId).find('.choice').removeClass('selected');
    $(this).closest('.choice').addClass('selected');

    sendAnswerAjax(questionId, choiceId, reviewChecked);
});

// **è¦‹ç›´ã—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹**
$(document).on('change', '.review-check', function() {
    let questionId = $(this).closest('.question').data('question-id');
    let reviewFlag = $(this).is(':checked');
    
    let selectedChoiceId = $('#q-'+questionId).find('.choice-radio:checked').val() || null;
    
    if (selectedChoiceId === "") {
        selectedChoiceId = null;
    }
    
    // è¦‹ç›´ã—ãƒã‚§ãƒƒã‚¯ã®å¤‰æ›´ã¯ isReviewToggle=true ã§é€ä¿¡
    sendAnswerAjax(questionId, selectedChoiceId, reviewFlag, true);
});

// **ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³**
$('#prev').click(function() {
    showQuestion(currentQuestionIndex - 1);
});

$('#next').click(function() {
    showQuestion(currentQuestionIndex + 1);
});

// **è§£ç­”è¦‹ç›´ã—ç”»é¢ã¸ã®é·ç§»**
$('#review-list-btn').click(function() {
    if (mockExamId > 0) {
        // MockExam ID ã‚’ä½¿ç”¨ã—ã¦ã€è¦‹ç›´ã—ç”»é¢ã¸é·ç§»
        window.location.href = '/exam/review/' + mockExamId;
    } else {
        console.error('Mock Exam ID is missing. Cannot navigate to review.');
    }
});

// **æ—¢å­˜ã®è§£ç­”çŠ¶æ³ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«åˆæœŸè¨­å®šã™ã‚‹**
function initializeAnswerStatus(answerDtos) {
    answerDtos.forEach(function(answerDto) {
        let questionId = answerDto.questionId; 
        let selectedChoiceId = answerDto.selectedChoiceId;
        
        // selectedChoiceIdãŒnullã¾ãŸã¯0ã®å ´åˆã€æœªè§£ç­”ã¨åˆ¤æ–­
        let answered = (selectedChoiceId != null && selectedChoiceId > 0); 

        if (questionId) {
             answerStatus[questionId] = { 
                answered: answered, 
                review: answerDto.reviewFlag, // DTOã‹ã‚‰ç›´æ¥å–å¾—
                choiceId: selectedChoiceId
            };
        }
    });
}

// **åˆæœŸåŒ–å‡¦ç†**
$(document).ready(function() {
    // 1. æ—¢å­˜ã®è§£ç­”çŠ¶æ³ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«èª­ã¿è¾¼ã‚€
    initializeAnswerStatus(existingAnswers); 
    
    // 2. ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
    if (totalSeconds > 0) {
        updateTimer(); 
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    // 3. æœ€åˆã®å•é¡Œã‚’è¡¨ç¤º
    if (questionsCount > 0) {
        showQuestion(initialQuestionIndex); 
    } else {
        $('#question-container').html('<p class="text-center text-lg p-8 text-gray-600">ã“ã®è©¦é¨“ã«ã¯ã¾ã å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>');
    }
    
    // 4. ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
    hljs.highlightAll();
});
/*]]>*/
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>

</body>
</html>