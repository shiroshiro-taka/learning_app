<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${question.id == null ? '問題新規作成' : '問題編集'}">問題登録・編集</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwindのカスタム設定 (他の画面と共通化)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1c55c8', // ボタンやアクセント用の青
                        'primary-blue-hover': '#1747a5',
                        'success-green': '#10b981', // 保存ボタン、追加ボタンの緑
                        'error-red': '#ef4444',     // 削除ボタンの赤
                        'gray-button': '#6b7280',   // 戻るボタンの灰色
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* テキストエリアのサイズ調整 */
        .input-text-area {
            min-height: 100px; /* 問題文 */
        }
        .choice-text-area {
            min-height: 50px; /* 選択肢 */
        }
        .explanation-text-area {
            min-height: 400px; /* 解説 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <!-- メインコンテナ -->
    <div class="max-w-6xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-8 border-primary-blue">
        
        <!-- タイトル -->
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-3" 
            th:text="${question.id == null ? '問題新規作成' : '問題編集'}">
            問題新規作成
        </h1>
        
        <!-- フォーム -->
        <form th:action="${question.id == null} ? @{/admin/questions} : @{'/admin/questions/' + ${question.id}}"
              method="post">

            <!-- フォームの2カラムコンテナ -->
            <div class="form-container flex flex-col lg:flex-row gap-6 lg:gap-8 min-h-[70vh]">

                <!-- 左側（問題文・選択肢、スクロール可能） -->
                <div class="left-column flex-1 lg:max-h-full overflow-y-auto pr-0 lg:pr-4 lg:border-r border-gray-200 space-y-6">

                    <!-- 分野 -->
                    <div>
                        <label for="category-id" class="block text-sm font-medium text-gray-700 mb-1">分野：</label>
                        <select id="category-id" name="category.id" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue sm:text-sm">
                            <option value="">選択してください</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat.id}"
                                    th:text="${cat.name}"
                                    th:selected="${question.category?.id == cat.id}">
                            </option>
                        </select>
                    </div>

                    <!-- 問題文 -->
                    <div>
                        <label for="question-text" class="block text-sm font-medium text-gray-700 mb-1">問題文：</label>
                        <textarea id="question-text" 
                                  name="questionText"
                                  th:text="${question.questionText}"
                                  required
                                  class="input-text-area mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue sm:text-sm"
                                  placeholder="問題文を入力してください"></textarea>
                    </div>

                    <!-- 選択肢 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">選択肢：</label>
                        <div id="choices-container" class="space-y-3">
                            <div th:each="choice, iterStat : ${question.choices}" class="choice-row flex items-start gap-3">
                                <textarea th:name="'choices[' + ${iterStat.index} + '].choiceText'"
                                          th:text="${choice.choiceText}"
                                          class="choice-text-area flex-1 mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue sm:text-sm"
                                          placeholder="選択肢を入力"></textarea>
                                <button type="button" class="delete-choice-btn flex-shrink-0 mt-1 px-3 py-2 text-sm font-semibold bg-error-red text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200" onclick="removeChoice(this)">削除</button>
                            </div>
                        </div>
                        <button type="button" class="add-choice-btn mt-4 inline-flex items-center px-4 py-2 text-sm font-semibold bg-success-green text-white rounded-lg shadow-md hover:bg-green-600 transition duration-200" onclick="addChoice()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            選択肢を追加
                        </button>
                    </div>

                    <!-- 正答 -->
                    <div>
                        <label for="correct-choice-select" class="block text-sm font-medium text-gray-700 mb-1">正答：</label>
                        <select id="correct-choice-select" name="correctChoiceIndex" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue sm:text-sm">
                            <option value="">選択してください</option>
                            <option th:each="choice, iterStat : ${question.choices}"
                                    th:value="${iterStat.index}"
                                    th:text="'選択肢 ' + ${iterStat.index + 1}"
                                    th:selected="${iterStat.index == question.correctChoiceIndex}">
                            </option>
                        </select>
                    </div>

                </div>

                <!-- 右側（解説、スクロール可能） -->
                <div class="right-column flex-1 space-y-6">
                    <label for="explanation" class="block text-sm font-medium text-gray-700 mb-1">解説：</label>
                    <textarea id="explanation" 
                              name="explanation"
                              th:text="${question.explanation}"
                              class="explanation-text-area mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue sm:text-sm"
                              placeholder="解説を入力（任意）"></textarea>
                </div>

            </div>

            <!-- ボタン群 -->
            <div class="flex justify-end space-x-4 pt-6 mt-6 border-t border-gray-100">
                <!-- 戻るボタン -->
                <a href="/admin/questions" 
                   class="px-5 py-2 rounded-lg font-semibold text-white bg-gray-button hover:bg-gray-600 transition duration-200 shadow-md flex items-center">
                    一覧に戻る
                </a>

                <!-- 保存ボタン -->
                <button type="submit" 
                        class="px-5 py-2 rounded-lg font-semibold text-white bg-success-green hover:bg-green-600 transition duration-200 shadow-md">
                    <span th:text="${question.id == null ? '新規作成' : '更新して保存'}">保存</span>
                </button>
            </div>

        </form>

    </div>

    <script>
        // --- 選択肢を削除する ---
        function removeChoice(button) {
            button.closest('.choice-row').remove();
            refreshChoiceIndexes();
        }

        // --- 新しい選択肢を追加する ---
        function addChoice() {
            const container = document.getElementById('choices-container');
            const index = container.children.length;

            const div = document.createElement('div');
            div.classList.add('choice-row', 'flex', 'items-start', 'gap-3');
            div.innerHTML = `
                <textarea name="choices[${index}].choiceText" 
                          class="choice-text-area flex-1 mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue sm:text-sm" 
                          placeholder="選択肢を入力"></textarea>
                <button type="button" 
                        class="delete-choice-btn flex-shrink-0 mt-1 px-3 py-2 text-sm font-semibold bg-error-red text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200" 
                        onclick="removeChoice(this)">削除</button>
            `;
            container.appendChild(div);
            refreshChoiceIndexes();
        }

        // --- 選択肢削除・追加後に正答リストを更新 ---
        function refreshChoiceIndexes() {
            const container = document.getElementById('choices-container');
            const select = document.getElementById('correct-choice-select');
            
            // 現在選択されている値を保持
            const currentSelectedValue = select.value;

            select.innerHTML = '<option value="">選択してください</option>';

            let newIndexToSelect = -1;

            Array.from(container.children).forEach((row, index) => {
                // name属性を再設定 (配列インデックスを修正)
                const textarea = row.querySelector('textarea');
                textarea.name = `choices[${index}].choiceText`;

                // 正答セレクトの再構築
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `選択肢 ${index + 1}`;
                select.appendChild(option);

                // 以前選択されていた値と同じインデックスがあるかチェック
                if (currentSelectedValue !== "" && parseInt(currentSelectedValue) === index) {
                    newIndexToSelect = index;
                }
            });
            
            // 以前選択されていた値を再設定（または最も近いもの）
            if (newIndexToSelect !== -1) {
                select.value = newIndexToSelect;
            } else if (currentSelectedValue !== "") {
                // 削除などによって以前の値が失われた場合、デフォルトに戻す
                select.value = "";
            }
        }
    </script>

</body>
</html>